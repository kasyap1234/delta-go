name: Deploy to GCP (Cloud Functions + GCE VM)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

env:
  CLOUD_FUNCTION_NAME: hmm-detector
  CLOUD_FUNCTION_REGION: us-central1
  GCE_ZONE: us-central1-a
  GCE_MACHINE_TYPE: e2-micro
  GCE_BOOT_DISK_TYPE: pd-standard
  GCE_BOOT_DISK_SIZE_GB: "30"

jobs:
  deploy-cloud-function:
    name: Deploy Cloud Function (gen2)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Stage function source
        run: |
          rm -rf ./gcf_src
          mkdir -p ./gcf_src
          cp cloud_function/app/main.py ./gcf_src/main.py
          cp cloud_function/requirements.txt ./gcf_src/requirements.txt
          cp -R models ./gcf_src/models
          cp -R python/regime_ml/src/regime_ml ./gcf_src/

      - name: Deploy function
        run: |
          gcloud functions deploy "${{ env.CLOUD_FUNCTION_NAME }}" \
            --gen2 \
            --region "${{ env.CLOUD_FUNCTION_REGION }}" \
            --runtime python312 \
            --source ./gcf_src \
            --entry-point detect_regime \
            --trigger-http \
            --set-env-vars HMM_MODEL_DIR=models \
            --allow-unauthenticated

  deploy-go-bot:
    name: Deploy Go bot to GCE VM (e2-micro)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod
          cache: true
          cache-dependency-path: go/go.sum

      - name: Build bot binary (linux/amd64)
        working-directory: go
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -trimpath -ldflags="-s -w" -o bot ./cmd/bot

      - name: Ensure VM exists (Always Free eligible config)
        run: |
          set -euo pipefail
          if gcloud compute instances describe "${{ secrets.GCE_INSTANCE_NAME }}" --zone "${{ env.GCE_ZONE }}" >/dev/null 2>&1; then
            echo "VM exists"
            exit 0
          fi

          gcloud compute instances create "${{ secrets.GCE_INSTANCE_NAME }}" \
            --zone "${{ env.GCE_ZONE }}" \
            --machine-type "${{ env.GCE_MACHINE_TYPE }}" \
            --provisioning-model STANDARD \
            --maintenance-policy MIGRATE \
            --create-disk=auto-delete=yes,boot=yes,image-family=ubuntu-2404-lts,image-project=ubuntu-os-cloud,mode=rw,size=${{ env.GCE_BOOT_DISK_SIZE_GB }},type=${{ env.GCE_BOOT_DISK_TYPE }} \
            --network-interface=stack-type=IPV4_ONLY,subnet=default \
            --tags=http-server,https-server

      - name: Copy binary to VM
        run: |
          gcloud compute scp \
            --zone "${{ env.GCE_ZONE }}" \
            --ssh-key-expire-after=1h \
            go/bot \
            "${{ secrets.GCE_SSH_USER }}@${{ secrets.GCE_INSTANCE_NAME }}:/tmp/delta-go-bot"

      - name: Install and restart bot
        run: |
          gcloud compute ssh \
            --zone "${{ env.GCE_ZONE }}" \
            --ssh-key-expire-after=1h \
            "${{ secrets.GCE_SSH_USER }}@${{ secrets.GCE_INSTANCE_NAME }}" \
            --command "set -euo pipefail
              sudo mkdir -p /opt/delta-go/bin
              sudo install -m 0755 /tmp/delta-go-bot /opt/delta-go/bin/bot
              rm -f /tmp/delta-go-bot

              if command -v systemctl >/dev/null 2>&1 && systemctl list-unit-files | grep -q '^delta-bot\.service'; then
                sudo systemctl daemon-reload
                sudo systemctl restart delta-bot
                sudo systemctl --no-pager --full status delta-bot || true
              else
                sudo pkill -f '/opt/delta-go/bin/bot' || true
                nohup sudo /opt/delta-go/bin/bot >/var/log/delta-bot.log 2>&1 &
              fi"
